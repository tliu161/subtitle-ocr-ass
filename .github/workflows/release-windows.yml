name: Windows Release

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      - name: Install dependencies
        run: |
          pip install -r requirements-release.txt

      # --------------------------------------------------
      # âœ… Download ffmpeg / ffprobe / ffplay
      # --------------------------------------------------
      - name: Download ffmpeg (Windows static)
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force bin | Out-Null

          $url = "https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip"
          $zip = "ffmpeg.zip"

          Write-Host "Downloading ffmpeg..."
          Invoke-WebRequest $url -OutFile $zip

          Write-Host "Extracting..."
          Expand-Archive $zip -DestinationPath ffmpeg_tmp -Force

          $exeDir = Get-ChildItem ffmpeg_tmp | Select-Object -First 1 | ForEach-Object {
            Join-Path $_.FullName "bin"
          }

          Copy-Item "$exeDir\ffmpeg.exe"  "bin\ffmpeg.exe"  -Force
          Copy-Item "$exeDir\ffprobe.exe" "bin\ffprobe.exe" -Force
          Copy-Item "$exeDir\ffplay.exe"  "bin\ffplay.exe"  -Force

          Remove-Item ffmpeg_tmp -Recurse -Force
          Remove-Item $zip -Force

          Write-Host "ffmpeg binaries ready:"
          Get-ChildItem bin

      # --------------------------------------------------
      # Build with PyInstaller
      # --------------------------------------------------
      - name: Build Windows exe
        run: |
          pyinstaller SubtitleOCR_ASS.spec

      # --------------------------------------------------
      # Zip release
      # --------------------------------------------------
      - name: Zip artifact
        shell: pwsh
        run: |
          Compress-Archive -Path dist/SubtitleOCR_ASS -DestinationPath SubtitleOCR_ASS-windows.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: SubtitleOCR_ASS-windows
          path: SubtitleOCR_ASS-windows.zip
