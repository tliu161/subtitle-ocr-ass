name: Release (Windows + macOS arm64)

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release tag (e.g. v0.1.0)"
        required: true
        default: "v0.1.0"

permissions:
  contents: write

jobs:
  tag:
    name: Create tag
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (main)
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Create and push tag
        shell: bash
        run: |
          TAG="${{ github.event.inputs.version }}"

          if [[ ! "$TAG" =~ ^v[0-9]+(\.[0-9]+){0,2}([\-+][0-9A-Za-z\.-]+)?$ ]]; then
            echo "Tag must look like v0.1.0 (or v0.1 or v0.1.0-rc1). Got: $TAG"
            exit 1
          fi

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Local tag $TAG exists."
          else
            git tag "$TAG"
          fi

          if git ls-remote --tags origin | grep -q "refs/tags/$TAG$"; then
            echo "Remote tag $TAG already exists. Skipping push."
          else
            git push origin "$TAG"
          fi

  build-windows:
    name: Build Windows
    needs: tag
    runs-on: windows-latest
    steps:
      - name: Checkout (tag)
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.version }}
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      - name: Install deps
        run: |
          pip install -r requirements-release.txt
          pip install pyinstaller

      - name: Download ffmpeg (Windows static)
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force bin | Out-Null

          $url = "https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip"
          $zip = "ffmpeg.zip"

          Invoke-WebRequest $url -OutFile $zip
          Expand-Archive $zip -DestinationPath ffmpeg_tmp -Force

          $root = (Get-ChildItem ffmpeg_tmp | Select-Object -First 1).FullName
          $exeDir = Join-Path $root "bin"

          Copy-Item "$exeDir\ffmpeg.exe"  "bin\ffmpeg.exe"  -Force
          Copy-Item "$exeDir\ffprobe.exe" "bin\ffprobe.exe" -Force
          Copy-Item "$exeDir\ffplay.exe"  "bin\ffplay.exe"  -Force

          Remove-Item ffmpeg_tmp -Recurse -Force
          Remove-Item $zip -Force

          Get-ChildItem bin

      - name: Build (PyInstaller spec)
        run: |
          pyinstaller --noconfirm --clean SubtitleOCR_ASS.spec

      - name: Zip Windows artifact
        shell: pwsh
        run: |
          if (!(Test-Path "dist/SubtitleOCR_ASS")) {
            Write-Error "dist/SubtitleOCR_ASS not found"
            exit 1
          }
          Compress-Archive -Path dist/SubtitleOCR_ASS/* -DestinationPath SubtitleOCR_ASS-windows.zip -Force

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows
          path: SubtitleOCR_ASS-windows.zip

  build-macos-arm64:
    name: Build macOS .app (arm64)
    needs: tag
    runs-on: macos-14
    steps:
      - name: Checkout (tag)
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.version }}
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install system deps (ffmpeg)
        run: |
          brew update
          brew install ffmpeg

      - name: Prepare bundled ffmpeg into ./bin
        run: |
          mkdir -p bin
          cp "$(brew --prefix)/bin/ffmpeg"  bin/ffmpeg || true
          cp "$(brew --prefix)/bin/ffprobe" bin/ffprobe || true
          cp "$(brew --prefix)/bin/ffplay"  bin/ffplay || true
          chmod +x bin/* || true
          ls -lah bin

      - name: Install python deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-release.txt
          pip install pyinstaller

      - name: Build .app (windowed)
        run: |
          pyinstaller --noconfirm --clean --windowed --name SubtitleOCR_ASS app/main.py

      - name: Verify output
        run: |
          ls -lah dist
          ls -lah "dist/SubtitleOCR_ASS.app" || (echo "Missing .app" && exit 1)

      - name: Zip .app for release
        run: |
          ditto -c -k --sequesterRsrc --keepParent "dist/SubtitleOCR_ASS.app" "SubtitleOCR_ASS-macos-arm64.app.zip"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm64
          path: SubtitleOCR_ASS-macos-arm64.app.zip

  release:
    name: Create GitHub Release
    needs: [build-windows, build-macos-arm64]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: |
          ls -R artifacts

      - name: Create/Update Release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.version }}
          name: SubtitleOCR_ASS ${{ github.event.inputs.version }}
          draft: false
          prerelease: false
          files: |
            artifacts/windows/SubtitleOCR_ASS-windows.zip
            artifacts/macos-arm64/SubtitleOCR_ASS-macos-arm64.app.zip
